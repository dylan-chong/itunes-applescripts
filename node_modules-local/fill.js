const fs = require('fs');
const log = require('./header-log.js').log;

// Matches '/* @fill a-keyword */'
const FILL_REGEX = /\/\*[ ]*@fill[ ]+[^ \*]+[ ]*\*\//g;

exports.getFilledString = getFilledString;

function getFilledString(templateObject, replacementsDictionary) {
  var template = getDataFromFileContentsObject(templateObject);
  var replacements = getReplacements(replacementsDictionary);

  var filledString = getFilledString(template, replacements);
  log('filledString', 0, filledString);
  return filledString;

  function getDataFromFileContentsObject(object) {
    return object.contents || fs.readFileSync(
        object.path, {encoding: 'utf8'});
  }

  function getReplacements(replacementsDictionary) {
    var r = {};
    for (var key in replacementsDictionary) {
      r[key] = getDataFromFileContentsObject(replacementsDictionary[key]);
    }
    return r;
  }

  function getFilledString(template, replacements) {
    var splitByFillComments = template.split(FILL_REGEX);

    var fillContents = getFillContents(template, replacements);
    log('fillContents', 0, fillContents);

    var filledString = '';

    for (var a = 0; a < fillContents.length; a++) {
      filledString += splitByFillComments[a] + fillContents[a];
    }
    filledString += splitByFillComments[splitByFillComments.length - 1];

    return filledString;

    function getFillContents(template, replacements) {
      var fillComments = template.match(FILL_REGEX);
      var fillCommentArguments = getFillCommentArguments(fillComments);
      var fillContents = [];

      for (var a = 0; a < fillCommentArguments.length; a++) {
        var arg = fillCommentArguments[a];
        
        // Get the contents to be replaced, or the original
        // @fill comment if no replacements exist
        fillContents[a] = replacements[arg] || fillComments[a];
        log('fillContents[' + a + '] = ', 2, fillContents[a]);
      }
      
      return fillContents;
      
      function getFillCommentArguments(fillComments) {
        var arguments = []; // Note: There is only one arg per fillComment
        
        for (var a = 0; a < fillComments.length; a++) {
          var words = fillComments[a].split(/[ ]+/);
          arguments[a] = words[words.indexOf('@fill') + 1];
        }
        
        return arguments;
      }
    }
  }
}

